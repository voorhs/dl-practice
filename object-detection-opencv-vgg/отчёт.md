# Отчёт о практическом задании “Детекция и классификация фишек Тантрикс”

Алексеев Илья Алексеевич, 317 группа, ВМК МГУ им. М.В.Ломоносова.

## Общие сведения

Решена следующая задача: дана картинка, содержащая изображения нескольких фишек из игры Тантрикс, необходимо для каждой фишки добавить текстовую подпись с её типом. Референс:

![](images/Dozen_0.bmp)

## Решение

### Коллекция фишек

Из имеющихся фотографий была собрана коллекция фишек на белом фоне (на каждой картинке по одной фишке).

![](data/train/1-01.bmp)![](data/train/2-01.bmp)![](data/train/3-01.bmp)![](data/train/4-01.bmp)![](data/train/5-01.bmp)![](data/train/6-01.bmp)![](data/train/7-01.bmp)![](data/train/8-01.bmp)![](data/train/9-01.bmp)![](data/train/10-01.bmp)

Код представлен в ноутбуке make_sample.ipynb. Основные использованные инструменты:

- поиск контуров [cv2.findContours()](https://docs.opencv.org/3.4/d3/dc0/group__imgproc__shape.html#ga17ed9f5d79ae97bd4c7cf18403e1689a)
- аппроксимация многоугольником [cv2.approxPolyDP()](https://docs.opencv.org/4.x/d3/dc0/group__imgproc__shape.html#ga0012a5fdaea70b8a9970165d98722b4c)

Коллекция составила 58 изображений.

### Разметка данных

Полученная коллекция

- размечена вручную на 10 классов (разметка содержится в названии файла)
- дополнена классом 11: объекты, которые похожи на фишки, но фишками не являются (несколько примеров ниже)

<img src="data/train/11-1.bmp" style="zoom:2.5%;" /><img src="data/train/11-6.bmp" style="zoom:5%;" /><img src="data/train/11-12.bmp" style="zoom:300%;" /><img src="data/train/11-27.bmp" style="zoom:80%;" />

Первые три картинки не являются фишками по очевидным причинам. Четвёртая не является фишкой потому, что конкретно такого пересечения линий нет среди данных в задании фишек.

- также в класс 11 добавлены картинки из интернета: логитипы, узоры — цветные и однотонные, а также мемы

Размеченная коллекция была поделена на обучающую выборку (76 объектов, data/train) и тестовую выборку (37 объектов, data/test).

### Классификатор

Построена и обучена нейросеть для классификации: на вход подается изображение (3,16,16) из размеченной выборки, на выходе — вероятности принадлежности классам 1..11. 

- Архитектура из двух VGG блоков и логистической регрессии (обучаемых параметров: 68621)

```python
VGGBlock = torch.nn.Sequential(
    nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1),
    nn.BatchNorm2d(out_channels),
    nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1),
    nn.ReLU(),
    nn.MaxPool2d(kernel_size=2),
    nn.BatchNorm2d(out_channels)
)

VGG = nn.Sequential(OrderedDict([
    ('vgg1', VGGBlock(3, 30)),
    ('vgg2', VGGBlock(30, 60)),
    ('flatten', nn.Flatten()),
    ('clf', nn.Linear(960, 11))
]))
```

### Аугментация

Необходима агрессивная аугментация, чтобы значительно разнообразить обучающую выборку. Исходное изображение:

![image-20230330191814715](отчёт.assets/image-20230330191836846.png)

Использованы следующие преобразования:

- поворот фишки на случайный угол из диапазона (-180, 180)

![image-20230330192115623](отчёт.assets/image-20230330192115623.png)

- случайный сдвиг изображения (shear) на случайный угол из диапазона (-15, 15)

![image-20230330191933263](отчёт.assets/image-20230330191933263.png)

- добавление шума Гаусса со стандартным отклонением 0.05

![image-20230330191855387](отчёт.assets/image-20230330191855387.png)

- удаление случайного прямоугольника из изображения

![image-20230330192202651](отчёт.assets/image-20230330192202651.png)

- колебание цвета, яркости, контраста

![image-20230330192225931](отчёт.assets/image-20230330192225931.png)![image-20230330192233295](отчёт.assets/image-20230330192233295.png)![image-20230330192303742](отчёт.assets/image-20230330192303742.png)

- размытие Гаусса с ядром (3,3) и стандартным отклонением 0.5

![image-20230330192329482](отчёт.assets/image-20230330192329482.png)

### Обучение нейросети

Гиперпараметры обучения:

- Число эпох: 2000 
- Оптимизатор: Adam с темпом обучения 1e-3
- Размер батча: 19
- Loss: кросс-энтропия

### Случай неуверенных предсказаний

Если нейросеть дает предсказание, далекое от уверенного, то индикатором этого может стать энтропия выданного распределения: если она больше некоторого порога (выбран порог 0.5), то объект причисляется к классу 11 (“мусорному” классу).

## Тесты

### Пайплайн тестирования

Чтобы применить разработанное решение к конкретному изображению, нужно

- получить изображения отдельных шестиугольников на белом фоне с помощью функции `get_hexagons()`
- загрузить веса обученной модели (файл `model.pth`)
- дать на вход функции `put_labels()` полученные изображения

### Тестовый датасет

Описанное решение дает 100% точность на тестовом датасете (data/test, 37 объектов):

![](отчёт.assets/test_res.png)

Чтобы посмотреть каждый пример по отдельности, нужно приблизить данный pdf-файл (простите).

### Мемы и мимикрирующие фишки

Описанное решение дает 100% точность на “мемном” датасете (data/random, 9 объектов):

![](отчёт.assets/memes_res.png)

Обратим внимание на 4, 8, 9. Это фигуры, которые по форме и набору цветов похожи на фишки, но ими не являются. Эти три примера были главным камнем преткновения на протяжении всего решения:

- 4 пример с большой уверенностью классифицировался как фишка из-за наличия темного цвета
- 8, 9 примеры  — из-за наличия всех трех цветов

Когда стало ясно, что нельзя обучить сеть правильно классифицировать такие объекты просто увеличив число эпох, было принято два решения, которые и привели к отличным результатам:

- добавить в датасет больше примеров класса 11
- сделать аугментацию более агрессивной (увеличить интервалы изменения углов, сигм и т.п.)

### Аугментированный тестовый датасет

Для обученной сети самой сложной задачей, очевидно, является задача где нужно аугментировать тестовую выборку. Описанное решение дает 100% точность даже здесь.

![](отчёт.assets/augmented_res.png)

### Исходные картинки

На всех картинках Single, Group и на картинке Dozen_0 решение дает правильные ответы.

![](отчёт.assets/singles.png)

![](отчёт.assets/groups.png)

![](отчёт.assets/dozen-1680204657045-15.png)

Всего одна ошибка: на картинке Group_6 мелкий узор на скатерти воспринимается как фишка 3.

## Итоги

Общий подход к решению таков:

- детекция шестиугольников с помощью средств `opencv`
- классификация шестиугольников с помощью свёрточной нейросети
- т.к. задача достаточно проста и датасет весьма беден на примеры, то
  - агрессивная аугментация
  - добавление собственных примеров на основе анализа ошибок классификатора

